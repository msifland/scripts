#!/bin/sh
# =============================================================================
# Custom Resolution Setup – pure POSIX /bin/sh version
# 100% working on Debian/Ubuntu/Mint etc. (X11 only)
# No bashisms, no shortcuts, no one-liners
# =============================================================================

# Paths
XPROFILE="$HOME/.xprofile"
AUTOSTART_DIR="$HOME/.config/autostart"
DESKTOP_FILE="$AUTOSTART_DIR/custom-resolution.desktop"
if [ ! -d "$AUTOSTART_DIR" ]; then
    mkdir -p "$AUTOSTART_DIR"
fi

# ------------------------------------------------------------------
# 1. Ask user for width and height
# ------------------------------------------------------------------
while true; do
    printf 'Enter desired resolution (width height, e.g. 1752 985, 1800 1012): '
    read WIDTH HEIGHT JUNK || exit 1

    # Simple integer check (POSIX way)
    case "$WIDTH" in ''|*[!0-9]*) WIDTH=0 ;; esac
    case "$HEIGHT" in ''|*[!0-9]*) HEIGHT=0 ;; esac

    if [ "$WIDTH" -gt 0 ] && [ "$HEIGHT" -gt 0 ]; then
        break
    fi
    echo "Please enter two positive numbers."
done

RESOLUTION="${WIDTH}x${HEIGHT}"
MODE_NAME="${WIDTH}x${HEIGHT}_60.00"   # safe name without quotes

# ------------------------------------------------------------------
# 2. Generate clean modeline (replace the quoted name with our safe name)
# ------------------------------------------------------------------
# cvt output example:
# Modeline "2256x1504_60.00"  181.71  2256 2272 2464 2784  1504 1507 1517 1555 -hsync +vsync
RAW_MODELINE=$(cvt "$WIDTH" "$HEIGHT" 60 | grep '^Modeline ' | sed 's/^Modeline  *//')

# Replace the first quoted part with our MODE_NAME
# First remove everything up to the first quote, then replace the quoted part
FRONT=$(echo "$RAW_MODELINE" | sed 's/^\([^"]*\)".*/\1/')
REST=$(echo "$RAW_MODELINE" | sed 's/^[^"]*"[^"]*" *//')
MODELINE="$FRONT\"$MODE_NAME\" $REST"

# ------------------------------------------------------------------
# 3. Detect the primary connected output
# ------------------------------------------------------------------
DISPLAY_NAME=$(xrandr | grep ' connected' | head -n 1 | awk '{print $1}')
if [ -z "$DISPLAY_NAME" ]; then
    echo "Error: No connected display found!"
    exit 1
fi

printf 'Display     : %s\n' "$DISPLAY_NAME"
printf 'Resolution  : %s\n' "$RESOLUTION"
printf 'Mode name   : %s\n\n' "$MODE_NAME"

gen_mode(){
    if [ -f "$XPROFILE" ]; then
        rm -f "$XPROFILE"
    fi
    if [ -f "$DESKTOP_FILE" ]; then
        rm -f "$DESKTOP_FILE"
    fi
    # ------------------------------------------------------------------
    # 4. Write ~/.xprofile (pure sh, works even when no DISPLAY is set yet)
    # ------------------------------------------------------------------
    cat > "$XPROFILE" << EOF
#!/bin/sh
# Custom resolution – generated $(date)
# Find the correct DISPLAY and XAUTHORITY at login time
DISPLAY=\$(w -h \$(id -u) 2>/dev/null | awk '/[:][0-9][0-9]*[ ]/{print \$3; exit}')
export DISPLAY
export XAUTHORITY="\$HOME/.Xauthority"

# Clean any previous instance of this mode
xrandr --rmmode "$MODE_NAME" 2>/dev/null || true
xrandr --delmode "$DISPLAY_NAME" "$MODE_NAME" 2>/dev/null || true

# Create and apply the new mode
xrandr --newmode $MODELINE
xrandr --addmode "$DISPLAY_NAME" "$MODE_NAME"
xrandr --output "$DISPLAY_NAME" --mode "$MODE_NAME" --primary

sleep 1   # small delay helps on some drivers
EOF

    chmod +x "$XPROFILE"

    # ------------------------------------------------------------------
    # 5. Create autostart .desktop file
    # ------------------------------------------------------------------
    mkdir -p "$AUTOSTART_DIR"
    cat > "$DESKTOP_FILE" << EOF
[Desktop Entry]
Type=Application
Name=Custom Resolution
Comment=Apply custom display resolution at login
Exec=$XPROFILE
Hidden=false
NoDisplay=false
X-GNOME-Autostart-enabled=true
EOF

    # ------------------------------------------------------------------
    # 6. Apply the resolution IMMEDIATELY in the current session
    # ------------------------------------------------------------------
    echo "Applying $RESOLUTION right now ..."
    echo "Screen may flicker or go black for 1-2 seconds – this is normal."

    # Clean old mode (if any)
    xrandr --rmmode "$MODE_NAME" 2>/dev/null || true
    xrandr --delmode "$DISPLAY_NAME" "$MODE_NAME" 2>/dev/null || true

    # Add and switch
    xrandr --newmode $MODELINE
    xrandr --addmode "$DISPLAY_NAME" "$MODE_NAME"
    xrandr --output "$DISPLAY_NAME" --mode "$MODE_NAME" --primary

    # Run it twice – some drivers need the second attempt
    sleep 1
    xrandr --output "$DISPLAY_NAME" --mode "$MODE_NAME" --primary 2>/dev/null || true
}
gen_mode
sleep 1
gen_mode

echo
echo "SUCCESS! Ignore color/font errors. $RESOLUTION is now active and will be applied automatically on every login."
exit 0

#Working bash version
<<comment
#!/bin/bash
# =============================================================================
# Custom Resolution Setup – 100% working on Debian/Ubuntu (X11 only)
# Fixes: BadName + "Can't open display" errors
# Tested on Intel, AMD, NVIDIA, laptops and desktops
# =============================================================================

# --- 4. Create the actual script that will run at login --------------------
XPROFILE="$HOME/.xprofile"
CFG_AUTO="$HOME/.config/autostart/custom-resolution.desktop"

# --- 1. Ask for resolution --------------------------------------------------
while true; do
    read -p "Enter desired resolution (width height, e.g. 1752 985, 1800 1012): " WIDTH HEIGHT
    if [[ $WIDTH =~ ^[0-9]+$ ]] && [[ $HEIGHT =~ ^[0-9]+$ ]] && (( WIDTH > 0 && HEIGHT > 0 )); then
        break
    fi
    echo "Please enter two positive numbers."
done
RES="${WIDTH}x${HEIGHT}"
MODENAME="${WIDTH}x${HEIGHT}_60.00" # safe name, no quotes/spaces

function gen_mode(){
# --- 2. Generate clean modeline (no quotes) --------------------------------
MODELINE=$(cvt "$WIDTH" "$HEIGHT" | grep Modeline | sed 's/Modeline //' | sed "s/^\"[^\"]*\"/\"$MODENAME\"/")
# --- 3. Detect the connected display ----------------------------------------
DISPLAY_NAME=$(xrandr | grep -w connected | head -n1 | awk '{print $1}')
if [[ -z "$DISPLAY_NAME" ]]; then
    echo "Error: No connected display found!"
    exit 1
fi
echo "Display : $DISPLAY_NAME"
echo "Resolution : $RES"
echo "Mode name : $MODENAME"
echo
cat > "$XPROFILE" <<EOF
#!/bin/sh
# Custom resolution – generated $(date)
# Find the correct X server and authority (this fixes "Can't open display")
export DISPLAY="\$(w -\$(id -u) | awk '/\\s:\\\\d+\\s/ {print \$3; exit}')"
export XAUTHORITY="\$HOME/.Xauthority"
# Clean old mode if it exists
xrandr --rmmode "$MODENAME" 2>/dev/null || true
xrandr --delmode "$DISPLAY_NAME" "$MODENAME" 2>/dev/null || true
# Add and apply new mode
xrandr --newmode $MODELINE
xrandr --addmode "$DISPLAY_NAME" "$MODENAME"
xrandr --output "$DISPLAY_NAME" --mode "$MODENAME" --primary
sleep 1 # tiny delay helps on some drivers
EOF
chmod +x "$XPROFILE"
# --- 5. Autostart entry (works on GNOME, XFCE, Cinnamon, KDE, etc.) ---------
mkdir -p "$HOME/.config/autostart"
cat > "$CFG_AUTO" <<EOF
[Desktop Entry]
Type=Application
Name=Custom Resolution
Comment=Apply custom display resolution at login
Exec=$XPROFILE
Hidden=false
NoDisplay=false
X-GNOME-Autostart-enabled=true
EOF
# --- 6. Apply it RIGHT NOW (in the current X session) ----------------------
echo "Applying $RES right now ..."
echo "If the screen goes black for 1–2 seconds – that's normal."
# This part runs with your current DISPLAY (so it works immediately)
bash -c "xrandr --rmmode \"$MODENAME\" 2>/dev/null || true"
bash -c "xrandr --delmode \"$DISPLAY_NAME\" \"$MODENAME\" 2>/dev/null || true"
bash -c "xrandr --newmode $MODELINE"
bash -c "xrandr --addmode \"$DISPLAY_NAME\" \"$MODENAME\""
bash -c "xrandr --output \"$DISPLAY_NAME\" --mode \"$MODENAME\" --primary"
}
gen_mode
sleep 1
gen_mode
echo
echo "SUCCESS! $RES is now active and will be applied automatically on every login."
exit 0
comment
