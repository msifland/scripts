#!/bin/bash
# =============================================================================
# Custom Resolution Setup – 100% working on Debian/Ubuntu (X11 only)
# Fixes: BadName + "Can't open display" errors
# Tested on Intel, AMD, NVIDIA, laptops and desktops
# =============================================================================

# --- 4. Create the actual script that will run at login --------------------
XPROFILE="$HOME/.xprofile"
CFG_AUTO="$HOME/.config/autostart/custom-resolution.desktop"

# --- 1. Ask for resolution --------------------------------------------------
while true; do
    read -p "Enter desired resolution (width height, e.g. 1752 985, 1800 1012): " WIDTH HEIGHT
    if [[ $WIDTH =~ ^[0-9]+$ ]] && [[ $HEIGHT =~ ^[0-9]+$ ]] && (( WIDTH > 0 && HEIGHT > 0 )); then
        break
    fi
    echo "Please enter two positive numbers."
done
RES="${WIDTH}x${HEIGHT}"
MODENAME="${WIDTH}x${HEIGHT}_60.00" # safe name, no quotes/spaces

function gen_mode(){
# --- 2. Generate clean modeline (no quotes) --------------------------------
MODELINE=$(cvt "$WIDTH" "$HEIGHT" | grep Modeline | sed 's/Modeline //' | sed "s/^\"[^\"]*\"/\"$MODENAME\"/")
# --- 3. Detect the connected display ----------------------------------------
DISPLAY_NAME=$(xrandr | grep -w connected | head -n1 | awk '{print $1}')
if [[ -z "$DISPLAY_NAME" ]]; then
    echo "Error: No connected display found!"
    exit 1
fi
echo "Display : $DISPLAY_NAME"
echo "Resolution : $RES"
echo "Mode name : $MODENAME"
echo
cat > "$XPROFILE" <<EOF
#!/bin/sh
# Custom resolution – generated $(date)
# Find the correct X server and authority (this fixes "Can't open display")
export DISPLAY="\$(w -\$(id -u) | awk '/\\s:\\\\d+\\s/ {print \$3; exit}')"
export XAUTHORITY="\$HOME/.Xauthority"
# Clean old mode if it exists
xrandr --rmmode "$MODENAME" 2>/dev/null || true
xrandr --delmode "$DISPLAY_NAME" "$MODENAME" 2>/dev/null || true
# Add and apply new mode
xrandr --newmode $MODELINE
xrandr --addmode "$DISPLAY_NAME" "$MODENAME"
xrandr --output "$DISPLAY_NAME" --mode "$MODENAME" --primary
sleep 1 # tiny delay helps on some drivers
EOF
chmod +x "$XPROFILE"
# --- 5. Autostart entry (works on GNOME, XFCE, Cinnamon, KDE, etc.) ---------
mkdir -p "$HOME/.config/autostart"
cat > "$CFG_AUTO" <<EOF
[Desktop Entry]
Type=Application
Name=Custom Resolution
Comment=Apply custom display resolution at login
Exec=$XPROFILE
Hidden=false
NoDisplay=false
X-GNOME-Autostart-enabled=true
EOF
# --- 6. Apply it RIGHT NOW (in the current X session) ----------------------
echo "Applying $RES right now ..."
echo "If the screen goes black for 1–2 seconds – that's normal."
# This part runs with your current DISPLAY (so it works immediately)
bash -c "xrandr --rmmode \"$MODENAME\" 2>/dev/null || true"
bash -c "xrandr --delmode \"$DISPLAY_NAME\" \"$MODENAME\" 2>/dev/null || true"
bash -c "xrandr --newmode $MODELINE"
bash -c "xrandr --addmode \"$DISPLAY_NAME\" \"$MODENAME\""
bash -c "xrandr --output \"$DISPLAY_NAME\" --mode \"$MODENAME\" --primary"
}
gen_mode
sleep 1
gen_mode
echo
echo "SUCCESS! $RES is now active and will be applied automatically on every login."
exit 0
