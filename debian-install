#!/usr/bin/env bash
# ===================================================================
# debian-install – Full Debian MATE System Installer to Disk
# With Your Original sed + All sleep Pauses – 2025
# ===================================================================
set -euo pipefail
IFS=$'\n\t'

# -------------------------- Config ----------------------------------
INST_PTH="/mnt/deb-inst"
CONFIGS_DIR="$HOME/MSI_live-build/my_configs"
HOME_DIR="$HOME"
SCRIPTS_DIR="$HOME/scripts"
CHROOT_SCRIPT="$SCRIPTS_DIR/debian-install-continue"
PACKLIST="$CONFIGS_DIR/my_packs.list.chroot"
GOOGLE_CHRM_SCRIPT="$HOME/scripts/google-chrome-latest-install"

# -------------------------- Must be root ---------------------------
[[ "$EUID" -eq 0 ]] || error "This script must be run as root!"

# -------------------------- Helpers --------------------------------
log()   { echo -e "\n\033[1;36m==>\033[0m \033[1;33m$*\033[0m\n"; sleep 1; }
error() { echo -e "\033[1;31mERROR: $*\033[0m" >&2; exit 1; }
ask()   { read -rp "$1 [y/N] " ans; [[ "$ans" =~ ^[yY]$ ]]; }

#---------------------Explanation----------------------------------------
clear
log "Debian MATE Full System Installer"
echo "This will install a complete, personalized Debian MATE system to a disk."
echo "All data on the target disk will be erased if you choose to wipe it."
sleep 1

# -------------------------- Cleanup old session --------------------
log "Cleaning up previous install (if any)"
sleep 1
for dir in proc sys dev/pts dev; do umount "$INST_PTH/$dir" 2>/dev/null || true; done
umount "$INST_PTH" 2>/dev/null || true
rm -rf "$INST_PTH"
mkdir -p "$INST_PTH"
sleep 1

# -------------------------- Install latest debootstrap (YOUR WAY) ---
log "Downloading latest debootstrap"
sleep 1
mkdir -p "$INST_PTH/work"
cd "$INST_PTH/work"

DEBOOT_STRP=$(wget -qO- http://ftp.debian.org/debian/pool/main/d/debootstrap | grep "all.deb" | sort -V | tail -1 | sed -e 's:.*a href="::' -e 's:.>.*::')

wget "http://ftp.debian.org/debian/pool/main/d/debootstrap/$DEBOOT_STRP"
dpkg -i "$DEBOOT_STRP" >/dev/null
sleep 1

# -------------------------- Select target disk ---------------------
log "Available disks:"
sleep 1
lsblk -d -p -o NAME,SIZE,MODEL
echo
read -rp "Enter target disk (e.g. /dev/sdb): " TARGET_DISK
[[ -b "$TARGET_DISK" ]] || error "Not a valid block device: $TARGET_DISK"
sleep 1

# Unmount anything on this disk
mapfile -t mounted < <(lsblk -nrp -o NAME,MOUNTPOINT "$TARGET_DISK" | grep -v '^$')
for mnt in "${mounted[@]}"; do
    umount "${mnt%% *}" 2>/dev/null || true
done

# Optional wipe
ask "Wipe the entire disk with zeros first? (slow but secure)" && {
    log "Wiping first 10MB of $TARGET_DISK (secure headers)"
    dd if=/dev/zero of="$TARGET_DISK" bs=10M count=1 status=progress
    sleep 1
}

# -------------------------- Partition with cfdisk ------------------
log "Launching cfdisk on $TARGET_DISK"
sleep 1
echo "Recommended layout:"
echo "  • /boot (512M–2G, type: EFI System if UEFI, or Linux filesystem if BIOS)"
echo "  • / (20G+, ext4)"
echo "  • /home (rest, ext4) – optional"
sleep 1
read -rsp "Press ENTER when ready to launch cfdisk..."
cfdisk "$TARGET_DISK"
sleep 1

log "Current partition table:"
sleep 1
lsblk -f "$TARGET_DISK"
sleep 1

# -------------------------- Format partitions ----------------------
log "Opening terminal to format partitions"
echo "Run: mkfs.ext4 -L ROOT /dev/xxx1   (for root)"
echo "      mkfs.ext4 -L HOME /dev/xxx3   (if separate /home)"
echo "      mkfs.fat -F32 -n EFI /dev/xxx1 (if UEFI boot)"
sleep 5
read -rsp "Press ENTER when done formatting..."
xterm -e "bash -c 'echo; lsblk -f; echo; echo Use mkfs commands above; echo; bash'"
sleep 1

# -------------------------- Choose root partition ------------------
log "Select root partition"
sleep 1
lsblk -f "$TARGET_DISK"
read -rp "Enter root partition (e.g. /dev/sdb2): " ROOT_PART
[[ -b "$ROOT_PART" ]] || error "Invalid partition"
sleep 1

# -------------------------- Debootstrap -----------------------------
log "Running debootstrap (this takes 5–15 minutes)"
sleep 1
mount "$ROOT_PART" "$INST_PTH"
debootstrap --arch=amd64 \
    --components=main,contrib,non-free,non-free-firmware \
    testing "$INST_PTH" http://deb.debian.org/debian/
sleep 1

# -------------------------- Mounts & network -----------------------
log "Mounting system directories"
sleep 1
mount -t proc  none   "$INST_PTH/proc"
mount -t sysfs none   "$INST_PTH/sys"
mount -o bind  /dev   "$INST_PTH/dev"
mount -o bind  /dev/pts "$INST_PTH/dev/pts"

cp -f /etc/resolv.conf "$INST_PTH/etc/"
install -Dm644 /etc/apt/sources.list.d/debian.sources "$INST_PTH/etc/apt/sources.list.d/"

[[ -f "$CONFIGS_DIR/my_preferences.pref" ]] &&
    install -Dm644 "$CONFIGS_DIR/my_preferences.pref" "$INST_PTH/etc/apt/preferences.d/"

install -Dm755 "$CHROOT_SCRIPT" "$INST_PTH/debian-install-continue"
install -Dm644 "$PACKLIST" "$INST_PTH/my_packs.list.chroot"
install -Dm755 "$GOOGLE_CHRM_SCRIPT" "$INST_PTH/google-chrome-latest-install"

# -------------------------- Chroot & finish -----------------------
log "Entering chroot to complete installation"
sleep 1
chroot $INST_PTH /bin/bash -i -c "part_name='$part_name' source /debian-install-continue"

# Cleanup chroot helpers
rm -f "$INST_PTH"/{debian-install-continue,my_packs.list.chroot}

# -------------------------- Handle separate partitions -------------
handle_separate_partitions() {
    while true; do
        log "Current mounts:"
        lsblk -f
        read -rp "Enter mountpoint (e.g. home, boot, var) or leave blank to finish: " mp
        [[ -z "$mp" ]] && break

        read -rp "Enter partition for /$mp (e.g. /dev/sdb3): " part
        [[ -b "$part" ]] || { echo "Invalid"; continue; }

        mkdir -p "$INST_PTH/$mp"
        mount "$part" "$INST_PTH/$mp"

        uuid=$(blkid -s UUID -o value "$part")
        echo "UUID=$uuid  /$mp  ext4  defaults  0  2" >> "$INST_PTH/etc/fstab"
        log "/$mp mounted and added to fstab"
        sleep 1
    done
}

ask "Do you have separate /home, /boot, or other partitions?" && handle_separate_partitions

# -------------------------- Final fstab review ---------------------
log "Opening fstab for final review"
sleep 1
blkid
sleep 1
xterm -e "nano $INST_PTH/etc/fstab"
sleep 1

# -------------------------- Copy user data -------------------------
usrname=$(cat "$INST_PTH/usrnme.txt" 2>/dev/null || echo "user")
rm -f "$INST_PTH"/{usrnme.txt,usrnme_psswrd.txt,new_psswrd.txt}
USR_HOME="$INST_PTH/home/$usrname"

# Create standard dirs
for d in Downloads Documents "Modules-Apps" pkg_bkups Projects scripts \
         Templates Music Pictures Videos tmp Wallpapers MSI_live-build; do
    mkdir -p "$USR_HOME/$d"
done

read -rp "Copy your personal files (Documents, scripts, Projects, etc.)? [y/N] " ans
if [[ "$ans" =~ ^[yY]|[yY][eE][sS]$ ]]; then
    echo "Copying personal files using git clone..."
    cp "$HOME/scripts/git-clone-my-repos" "$USR_HOME/git-clone-my-repos"
    cd $USR_HOME
    /bin/bash git-clone-my-repos
    cd "$INST_PTH"
echo
echo "Done cloning pernal git repos"

# --------------------- Copy dotfiles/configs (optional) -----------
read -rp "Copy config files (.config, .local, .bashrc, etc.)? [y/N] " ans
if [[ "$ans" =~ ^[yY]$ ]]; then
    echo "Copying configuration files..."
    rsync -a --progress --exclude={chrome-remote-desktop,chromium,google-chrome,skypeforlinux,Code,variety} \
        "$HOME_DIR/.config"     "$USR_HOME/"
    rsync -a --progress --exclude={share/applications,share/baloo,share/akonadi,share/lutris,share/Steam,share/Trash} \
        "$HOME_DIR/.local"      "$USR_HOME/"
    rsync -a --progress --exclude={chromium,mozilla,tracker,wine*,google-chrome,at-spi*} \
        "$HOME_DIR/.cache"      "$USR_HOME/"
    for f in .Xresources .conkyrc .conkyrc.bak .bashrc .xprofile; do
        [[ -f "$HOME_DIR/$f" ]] && cp -a "$HOME_DIR/$f" "$USR_HOME/"
    done
fi

# --------------------- Fix permissions -----------------------------
chown -R "$usrname:$usrname" "$USR_HOME"

# -------------------------- GRUB install ---------------------------
log "Installing GRUB bootloader"
sleep 1
DISK="${ROOT_PART%[0-9]*}"

if [[ -d "$INST_PTH/boot/efi" ]]; then
    log "UEFI detected – installing grub-efi"
    chroot "$INST_PTH" grub-install --target=x86_64-efi --efi-directory=/boot/efi --bootloader-id=Debian
else
    log "BIOS detected – installing grub-pc"
    chroot "$INST_PTH" grub-install "$DISK"
fi

chroot "$INST_PTH" update-grub
sleep 1

# Optional: disable os-prober
ask "Disable os-prober in GRUB? (recommended for privacy)" && {
    echo "GRUB_DISABLE_OS_PROBER=true" >> "$INST_PTH/etc/default/grub"
    chroot "$INST_PTH" update-grub
    sleep 1
}

# -------------------------- Final steps ----------------------------
install -Dm644 "$CONFIGS_DIR/msifland" "$INST_PTH/etc/sudoers.d/msifland"

# --------------------- Final pause ---------------------------------
echo
log "Almost done! You can now:
        • Open another terminal and chroot in: sudo chroot $INST_PTH
        • Inspect the filesystem in your file manager"
echo
echo
read -rsp "Press ENTER when ready to build the live ISO..."
rm -rf "$INST_PTH/work"
echo
log "Installation complete! Unmounting..."
sleep 1
umount "$INST_PTH"/{proc,sys,dev/pts,dev} 2>/dev/null || true
umount "$INST_PTH"/* 2>/dev/null || true
umount "$INST_PTH" 2>/dev/null || true
sleep 1

log "ALL DONE!"
sleep 1
echo "You can now reboot and boot from $TARGET_DISK"
echo "Your username: $usrname"
echo "Enjoy your brand new personalized Debian MATE system!"
sleep 1
