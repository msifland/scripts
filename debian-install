#!/bin/bash
# This is a blank bash script document.
# Put your code below this line.
# Check if script has been run as root.
if [[ ! "$USER" = "root" ]]; then
	echo "This script must be run as root!"
	exit
fi
$HOME/scripts/wipe-partition
if [[ -d /mnt/deb-inst ]]; then
rm -rf /mnt/deb-inst
fi

cd /
mkdir /mnt
mkdir /mnt/deb-inst
mkdir /mnt/deb-inst/work
cd /mnt/deb-inst/work

DEBOOT_STRP=$(wget -qO- http://ftp.debian.org/debian/pool/main/d/debootstrap | grep "all.deb" | sort -V | tail -1 | sed -e 's:.*a href="::' -e 's:.>.*::' )
wget http://ftp.debian.org/debian/pool/main/d/debootstrap/"$DEBOOT_STRP"

cd /
dpkg -i /mnt/deb-inst/work/*.deb

echo
lsblk
read -p "Enter partition to configure(/dev/sdb): " part_conf
cfdisk $part_conf
echo
lsblk
echo "Now you need to format earch partition as ext4. A new terminal will open and for each partition type 'sudo mkfs -t ext4 /dev/sdXY. Then type exit to close the terminal and continue the install process."
sleep 5
mate-terminal -e "sh -c \"echo; echo; lsblk; echo; echo; sh\""
echo

read -p "Enter partition name to install to(ex. /dev/sdb1): " part_name
umount $part_name
umount $part_conf

mount $part_name /mnt/deb-inst

debootstrap --arch amd64 testing /mnt/deb-inst http://ftp.us.debian.org/debian/

mount -t proc /proc /mnt/deb-inst/proc
mount -t sysfs /sys /mnt/deb-inst/sys
mount -o bind /dev /mnt/deb-inst/dev
mount -o bind /dev/pts /mnt/deb-inst/dev/pts

cp /etc/network/interfaces /mnt/deb-inst/etc/network/interfaces
cp /etc/resolv.conf /mnt/deb-inst/etc/resolv.conf
cp /etc/hosts /mnt/deb-inst/etc/hosts
cp /etc/hostname /mnt/deb-inst/etc/hostname
cp /etc/apt/sources.list /mnt/deb-inst/etc/apt/sources.list
nano /mnt/deb-inst/etc/apt/sources.list
cp /home/msifland/scripts/debian-install-continue /mnt/deb-inst/debian-install-continue

cat << EOF | part_name=$part_name chroot /mnt/deb-inst env /bin/bash
./debian-install-continue
EOF
sudo nano /mnt/deb-inst/etc/apt/sources.list

read -p "What partition would you like to install grub to? Debian install was to $part_name(ex. /dev/sdb). " grb_inst
sudo grub-install $grb_inst
sudo update-grub $grb_inst

read -p "Would you like to install you personal file for this installation[y/n]? " per_fls
if[[ $per_fls = "y" ]]; then
	cp -rf $HOME/Documents /mnt/deb-inst/home/msifland/
	cp -rf $HOME/"Modules&Apps" /mnt/deb-inst/home/msifland/
	cp -rf $HOME/pkg_bkups /mnt/deb-inst/home/msifland/
	cp -rf $HOME/Projects /mnt/deb-inst/home/msifland/
	cp -rf $HOME/scripts /mnt/deb-inst/home/msifland/
	cp -rf $HOME/.config /mnt/deb-inst/home/msifland/
	cp -rf $HOME/.local /mnt/deb-inst/home/msifland/
fi

sudo umount /mnt/deb-inst/proc
sudo umount /mnt/deb-inst/sys
sudo umount /mnt/deb-inst/dev/pts
sudo umount /mnt/deb-inst/dev
sudo umount /mnt/deb-inst

exit
