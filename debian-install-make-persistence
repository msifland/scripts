#!/usr/bin/env bash
# ===================================================================
# add-persistence-to-iso.sh – RAM + Persistent boot menu (size in GB)
# Call right after lb build finishes
# ===================================================================
set -euo pipefail


# CHANGE THIS ONE LINE ONLY — how many GB of persistence you want
PERSIST_SIZE_GB=""                    # 4 = 4 GB, 8 = 8 GB, 16 = 16 GB, etc.
LIVE_BUILD_ROOT="$HOME/MSI_live-build"
LIVE_BUILD_FILES="$LIVE_BUILD_ROOT/MSI_live-iso"
ISO_PATH="$LIVE_BUILD_ROOT/MSI_live-image-amd64.hybrid.iso"

echo
echo -n "${ILCOLOR2}Making sure ownership is correct for Persistent build. Press [ENTER] to start${ILRESTORE}"
read
sudo chown -R $USER:$USER "$LIVE_BUILD_FILES"
sleep 1

cd "$LIVE_BUILD_ROOT"

echo
echo -n "${ILCOLOR2}How big, in GB, do you want your persistence drive to be(e.g. 4, 8, 100, 2). Default is 8 ${ILRESTORE}"
read PERSIST_SIZE_GB
if [[ "$PERSIST_SIZE_GB" = "" ]]; then
	echo "Deafaulted to 8 GB"
	sleep 1
	PERSIST_SIZE_GB=8
else
	echo "Persistance size set to: $PERSIST_SIZE_GB"
	sleep 1
fi

echo
echo "Injecting ${PERSIST_SIZE_GB} GB persistence + perfect two-option boot menu…"

# 1. Create live-rw file
echo "Applying bullet-proof persistence + dual BIOS/UEFI boot menu..."

# Inside your debian-install-make-persistent script – replace the whole block
TMPDIR=$LIVE_BUILD_ROOT/tmp
mkdir -p $TMPDIR
cd $TMPDIR
sudo dd if=/dev/zero of="live-rw" bs=1M count=$((PERSIST_SIZE_GB * 1024)) status=progress
sudo mkfs.ext4 -F live-rw

# Critical: set exact permissions and ownership that live-boot expects
sudo cp "$TMPDIR/live-rw" "$LIVE_BUILD_FILES/live-rw"
cd "$LIVE_BUILD_FILES"
sudo mount --mkdir -o loop live-rw /mnt/live-rw
# Critical: create persistence.conf with exact content and permissions
#echo "/ union" | sudo tee "/mnt/live-rw/persistence.conf"
sudo bash -c 'cat > /mnt/live-rw/persistence.conf<<EOF
/ union
EOF'
sudo umount /mnt/live-rw
cd $LIVE_BUILD_ROOT
rm -rf $TMPDIR
# UEFI GRUB (keeps working if someone boots UEFI)
cat > "$LIVE_BUILD_FILES/boot/grub/grub.cfg" <<'EOF'
set default="0"
set timeout=10
set gfxpayload=keep

menuentry "Debian MATE Live – RAM mode (grub.cfg)" {
    linux   /live/vmlinuz boot=live config quickreboot
    initrd  /live/initrd.img
}

menuentry "Debian MATE Live – Persistent mode (grub.cfg)" {
    linux   /live/vmlinuz boot=live persistent config quickreboot
    initrd  /live/initrd.img
}
EOF

# BIOS/ISOLINUX – this is the one your machine is actually using right now
cat > "$LIVE_BUILD_FILES/isolinux/isolinux.cfg" <<'EOF'
UI menu.c32
PROMPT 0
TIMEOUT 100
ONTIMEOUT 1

MENU TITLE Debian MATE Live

LABEL ram
    MENU LABEL Debian MATE Live – RAM mode (isolinux.cfg)
    LINUX /live/vmlinuz
    INITRD /live/initrd.img
    APPEND boot=live config quickreboot

LABEL persistent
    MENU LABEL Debian MATE Live – Persistent mode (isolinux.cfg)
    LINUX /live/vmlinuz
    INITRD /live/initrd.img
    APPEND boot=live persistent config quickreboot
EOF

rm -rf "$TMPDIR"
cd "$LIVE_BUILD_ROOT"
echo "Both BIOS and UEFI menus fixed. Persistence will work after next build."
sleep 1
echo
echo "SUCCESS! Your ISO now has a clean two-option boot menu:"
echo "   • RAM mode – fresh every boot"
echo "   • Persistent mode – ${PERSIST_SIZE_GB} GB (all changes saved)"
echo "Works perfectly with dd, Rufus, Ventoy, balenaEtcher, etc."
echo
