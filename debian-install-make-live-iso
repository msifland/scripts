#!/usr/bin/env bash
# ==================================================================
# Custom Debian Live ISO builder – Clean & Bulletproof Edition (2025)
# ==================================================================
set -euo pipefail                     # Strict mode: fail fast & loud
IFS=$'\n\t'                           # Safe word splitting
# ------Reference: If a line has ' || true' at the end, it means the script will keep running(NOT CRITITCAL COMMANDS). Used with the 'set -e' command above which stops the entire scripts if errors.
# ========================== CONFIGURATION ==========================
# Edit only these lines!
RT_DIR="$HOME/MSI_live-build"
CHROOT="/mnt/deb-inst"                             # Your populated chroot
ISO_NAME="$RT_DIR/MSI_live-image-amd64.hybrid.iso" # Final ISO path
OUTDIR="$RT_DIR/MSI_live-iso"                      # Temporary ISO tree
# ==================================================================

echo "=== Creating custom Debian Live hybrid ISO ==="
echo "   Chroot : $CHROOT"
echo "   Output : $ISO_NAME"
echo
sleep 2
# ------------------------------------------------------------------
# 0. Cleanup & prepare
# ------------------------------------------------------------------
#
rm -rf "$OUTDIR"
mkdir -p "$OUTDIR"/{boot/grub,live,isolinux,EFI/BOOT}

# ------------------------------------------------------------------
# 1. Copy kernel + initrd (fails loudly if missing)
# ------------------------------------------------------------------
cp "$CHROOT/boot/vmlinuz"*   "$OUTDIR/live/vmlinuz" || \
    { echo "ERROR: vmlinuz not found in $CHROOT/boot/"; exit 1; }
cp "$CHROOT/boot/initrd.img"* "$OUTDIR/live/initrd.img" || \
    { echo "ERROR: initrd.img not found in $CHROOT/boot/"; exit 1; }

# ------------------------------------------------------------------
# 2. Create squashfs (fast xz, excludes junk)
# ------------------------------------------------------------------
echo "Creating filesystem.squashfs (this may take 5–20 min)..."
#
sudo mksquashfs "$CHROOT" "$OUTDIR/live/filesystem.squashfs" -comp xz -wildcards -e 'dev/*' 'proc/*' 'sys/*' 'run/*' 'tmp/*' 'mnt/*' 'media/*' 'lost+found' 'var/cache/apt/archives/*'
echo "filesystem.squashfs created"

# ------------------------------------------------------------------
# 3. ISOLINUX (BIOS) files
# ------------------------------------------------------------------
sudo cp /usr/lib/ISOLINUX/{isolinux.bin,isohdpfx.bin} "$OUTDIR/isolinux/"
sudo cp /usr/lib/syslinux/modules/bios/*.c32 "$OUTDIR/isolinux/" 2>/dev/null || true

cat > "$OUTDIR/boot/grub/grub.cfg" <<'EOF'
set default="0"
set timeout=10
set gfxpayload=keep

menuentry "Debian MATE Live(grub.cfg)" {
    linux   /live/vmlinuz boot=live config locales=en_US.UTF-8 keyboard-layouts=us timezone=America/Chicago quickreboot
    initrd  /live/initrd.img
}
EOF

# BIOS/ISOLINUX – this is the one your machine is actually using right now
cat > "$OUTDIR/isolinux/isolinux.cfg" <<'EOF'
UI menu.c32
PROMPT 0
TIMEOUT 100
ONTIMEOUT 1

MENU TITLE Debian MATE Live

LABEL ram
    MENU LABEL Debian MATE Live(isolinux.cfg)
    LINUX /live/vmlinuz
    INITRD /live/initrd.img
    APPEND boot=live config locales=en_US.UTF-8 keyboard-layouts=us timezone=America/Chicago quickreboot
EOF

# ------------------------------------------------------------------
# 5. Build EFI boot image (80 MB FAT32)
# ------------------------------------------------------------------
EFI_IMG="$OUTDIR/boot/grub/efi.img"
echo "Building EFI boot image..."
dd if=/dev/zero of="$EFI_IMG" bs=1M count=80 status=none
sudo mkfs.vfat -F 32 -n "EFI" "$EFI_IMG" >/dev/null

# Populate with mtools (no mount → no accidents)
sudo mmd -i "$EFI_IMG" ::/EFI ::/EFI/BOOT ::/boot ::/boot/grub

if [[ -f /usr/lib/shim/shimx64.efi.signed ]]; then
    sudo mcopy -i "$EFI_IMG" /usr/lib/shim/shimx64.efi.signed ::/EFI/BOOT/BOOTX64.EFI
    echo "Using signed shim → Secure Boot compatible"
else
    sudo mcopy -i "$EFI_IMG" /usr/lib/grub/x86_64-efi/grubx64.efi ::/EFI/BOOT/BOOTX64.EFI
    echo "Using standard GRUB EFI binary"
fi

sudo mcopy -i "$EFI_IMG" "$OUTDIR/boot/grub/grub.cfg" ::/boot/grub/grub.cfg
sudo mcopy -i "$EFI_IMG" /usr/share/grub/unicode.pf2 ::/boot/grub/ 2>/dev/null || true

# Make EFI files visible inside the ISO (silences Ventoy/Rufus warnings)
cp -a /usr/lib/shim/shimx64.efi.signed "$OUTDIR/EFI/BOOT/BOOTX64.EFI" 2>/dev/null || \
    cp -a /usr/lib/grub/x86_64-efi/grubx64.efi "$OUTDIR/EFI/BOOT/BOOTX64.EFI"

# ------------------------------------------------------------------
# 6. Create the hybrid ISO with xorriso
# ------------------------------------------------------------------
echo
echo "Generating final hybrid ISO..."
sleep 1
xorriso -as mkisofs \
    -iso-level 4 -joliet -rock \
    -eltorito-boot isolinux/isolinux.bin \
    -no-emul-boot -boot-load-size 4 -boot-info-table \
    -eltorito-catalog isolinux/boot.cat \
    -eltorito-alt-boot \
    -e boot/grub/efi.img -no-emul-boot \
    -isohybrid-mbr /usr/lib/ISOLINUX/isohdpfx.bin \
    -isohybrid-gpt-basdat \
    -o "$ISO_NAME" \
    "$OUTDIR"

# Final hybrid magic (one command does MBR + GPT + UEFI fix)
echo "Applying isohybrid (BIOS + UEFI)..."
isohybrid -u "$ISO_NAME" || true   # -u = --uefi, does both in one pass

# ------------------------------------------------------------------
# 7. Done!
# ------------------------------------------------------------------
echo
echo "DONE! Your live ISO is ready:"
du -h "$ISO_NAME"
echo
sleep 1
# Fix ownership (optional convenience)
echo
echo "Making sure ownership is correct..."
sudo chown -R "${SUDO_USER:-$USER}":"${SUDO_USER:-$USER}" "$OUTDIR" "$ISO_NAME" 2>/dev/null || true
sleep 2
chmod 644 $ISO_NAME || true
cd "$RT_DIR"
echo "Happy hacking!"
