#!/usr/bin/env bash
# ===================================================================
# Debian MATE Live ISO Builder – Full Installer + Personal Configs
# Clean & Safe Edition – 2025
# ===================================================================
set -euo pipefail
IFS=$'\n\t'
# ------Reference: If a line has ' || true' at the end, it means the script will keep running(NOT CRITITCAL COMMANDS). Used with the 'set -e' command above which stops the entire scripts if errors.
# --------------------- Must run as root ----------------------------
if [[ "$EUID" -ne 0 ]]; then
    echo "ERROR: This script must be run as root!"
    exit 1
fi

# -------------------------- Config ----------------------------------
export HOME_DIR="$HOME"
INST_PTH="$HOME_DIR/tmp/deb-inst"
CONFIGS_DIR="$HOME_DIR/scripts/install-debian/my_configs"
SCRIPTS_DIR="$HOME_DIR/scripts"
CHROOT_CONTINUE_SCRIPT="$SCRIPTS_DIR/install-debian/debian-install-continue-iso-small"
LIVE_BUILD_SCRIPT="$SCRIPTS_DIR/install-debian/debian-install-make-live-iso"
GOOGLE_CHRM_SCRIPT="$HOME_DIR/scripts/google-chrome-latest-install"
# -------------------------------------------------------------------

clear
echo "============================================================"
echo "   Debian MATE Live ISO Builder-SMALL ISO (with personal configs)"
echo "============================================================"
echo
echo "This script will:"
echo "  • Install a fresh Debian testing chroot to $INST_PTH"
echo "  • Apply your package list and configs"
echo "  • Copy your personal files and dotfiles"
echo "  • Build the final live ISO"
echo

read -rp "Continue? [y/N] " answer
[[ "$answer" =~ ^[yY]$ ]] || { echo "Aborted."; exit 0; }

# ------------------------Custom Helper Functions ------------------------
log()    { echo -e "\n\033[1;36m==>\033[0m \033[1;33m$*\033[0m\n"; }
error()  { echo -e "\033[1;31mERROR: $*\033[0m" >&2; exit 1; }
ask()    { read -rp "$1 [y/N] " ans; [[ "$ans" =~ ^[[yY]|[yY][eE][sS]$ ]]; }

# --------------------- Cleanup old session -------------------------
log "Cleaning up any previous session..."
sleep 1
for dir in "$INST_PTH"/{proc,sys,dev/pts,dev}; do
    umount "$dir" 2>/dev/null || true
done
umount -R "$INST_PTH" 2>/dev/null || true
umount -R "$INST_PTH/home" || true
umount -R "$INST_PTH/boot/efi" || true
umount -R "$INST_PTH/boot" || true
umount -R "$INST_PTH/misc" || true
umount -R "$INST_PTH/proc" || true
umount -R "$INST_PTH/dev/pts" || true
umount -R "$INST_PTH/dev" || true
umount -R "$INST_PTH/sysfs" || true
umount -R "$INST_PTH/sys" || true
umount -R "$INST_PTH" || true

rm -rfv "$INST_PTH"
sleep 1
mkdir -pv "$INST_PTH"
sleep 1
# --------------------- Install latest debootstrap -----------------
log "Downloading and installing latest debootstrap..."
sleep 1
mkdir -pv "$INST_PTH/work"
cd "$INST_PTH/work"
# Formats the link to correctly download
latest_deb=$(wget -O- https://deb.debian.org/debian/pool/main/d/debootstrap/ | grep "all.deb" | sort -V | tail -1 | sed -e 's:.*a href="::' -e 's:.>.*::')
# Download correct version with above line
wget  "https://deb.debian.org/debian/pool/main/d/debootstrap/$latest_deb"
dpkg -i "$latest_deb" >/dev/null

# --------------------- Bootstrap Debian testing -------------------
log "Bootstrapping Debian testing (this takes a while)..."
sleep 1
debootstrap --arch=amd64 --components=main,contrib,non-free,non-free-firmware testing "$INST_PTH" http://deb.debian.org/debian/

# --------------------- Mount system dirs --------------------------
log "Mounting folders and systems"
sleep 1
mount -t proc  none     "$INST_PTH/proc"
mount -t sysfs none     "$INST_PTH/sys"
mount -o bind  /dev     "$INST_PTH/dev"
mount -o bind  /dev/pts "$INST_PTH/dev/pts"

# --------------------- Network configuration ----------------------
log "Setting up basic networking"
sleep 1
# 1. Copy current resolv.conf so DNS works inside chroot
cp -f /etc/resolv.conf "$INST_PTH/etc/resolv.conf"

# 2. Copy hosts and hostname (helps with some tools)
cp -f /etc/hosts     "$INST_PTH/etc/hosts"
cp -f /etc/hostname  "$INST_PTH/etc/hostname"

# 3. Traditional /etc/network/interfaces (still used by live-boot + ifupdown)
if [[ -f /etc/network/interfaces ]]; then
    install -Dm644 /etc/network/interfaces "$INST_PTH/etc/network/interfaces"
else
    # Fallback: create a minimal working one
    cat > "$INST_PTH/etc/network/interfaces" <<EOF
# Used by live-boot and ifupdown
auto lo
iface lo inet loopback

auto eth0
iface eth0 inet dhcp
EOF
fi

# --------------------- Fix apt sources (critical!) ----------------
log "Fixing apt sources configuration"
sleep 1
# Remove legacy sources.list if it exists (testing still creates it)
if [[ -f "$INST_PTH/etc/apt/sources.list" ]]; then
    rm -f "$INST_PTH/etc/apt/sources.list"
    echo "Removed old /etc/apt/sources.list"
    sleep 1
fi
# Ensure sources.list.d directory exists
mkdir -p "$INST_PTH/etc/apt/sources.list.d"

# 'instal' line explained: shortcut for copying with correct permissions and create directories if they don't exist.
# Copy sources and pinning
rsync -a --progress /etc/apt/ "$INST_PTH/etc/apt/"
install -Dm644 /etc/apt/sources.list.d/debian.sources "$INST_PTH/etc/apt/sources.list.d/"
install -Dm644 "$CONFIGS_DIR/my_preferences.pref"      "$INST_PTH/etc/apt/preferences.d/"

# Copy helper scripts
install -Dm755 "$CHROOT_CONTINUE_SCRIPT"               "$INST_PTH/debian-install-continue-iso"
install -Dm644 "$CONFIGS_DIR/my_packs-small.list.chroot"     "$INST_PTH/my_packs-small.list.chroot"
install -Dm755 "$GOOGLE_CHRM_SCRIPT"                   "$INST_PTH/google-chrome-latest-install"
# --------------------- Chroot and finish install ------------------
log "Entering chroot to finish package installation..."
sleep 1
chroot $INST_PTH /bin/bash -i -c "source /debian-install-continue-iso"

# Cleanup chroot helper files
rm -f "$INST_PTH"/{debian-install-continue-iso,my_packs-small.list.chroot}

# --------------------- Get username from chroot -------------------
usrnme=$(cat "$INST_PTH/usrnme.txt" 2>/dev/null || echo "user")
rm -f "$INST_PTH"/{usrnme.txt,usrnme_psswrd.txt,new_psswrd.txt}

USR_HOME="$INST_PTH/home/$usrnme"
log "Detected username: $usrnme"


# --------------------- Create standard directories ----------------
log "Creating standard user directories..."
sleep 1
for dir in Desktop Downloads Music Pictures Videos tmp Wallpapers; do
    mkdir -p "$USR_HOME/$dir"
done

# --------------------- Copy personal files (optional) -------------
cp "$HOME_DIR/scripts/git-clone-my-repos" "$USR_HOME/git-clone-my-repos"
read -rp "Would you like to add you git directories(Document, scripts, pkg_bkups, etc.)[y/N]: " add_docs
if [[ "$add_docs" =~ ^[yY]|[yY][eE][sS]$ ]]; then
    echo "Copying personal files using git clone..."
    cd $USR_HOME
    /bin/bash git-clone-my-repos
    rm -f "git-clone-my-repos"
    cd "$INST_PTH"
    echo
    echo "Done cloning pernal git repos"
else
    echo
    echo "Okay, skipping personal docs."
fi
sleep 1

# --------------------- Copy dotfiles/configs (optional) -----------
read -rp "Would you like to add you config files(.conig, .local, .cache, etc.)[y/N]: " add_confs
if [[ "$add_confs" =~ ^[yY]|[yY][eE][sS]$ ]]; then
    echo "Copying configuration files..."
    rsync -a --progress --exclude={chrome-remote-desktop,chromium,google-chrome,skypeforlinux,Code,variety} \
        "$HOME_DIR/.config"     "$USR_HOME/"
    rsync -a --progress --exclude={share/applications,share/baloo,share/akonadi,share/logs,share/lutris,share/skypeweb,share/Steam,share/Trash} \
        "$HOME_DIR/.local"      "$USR_HOME/"
    rsync -a --progress --exclude={chromium,mozilla,tracker,wine*,google-chrome,at-spi*} \
        "$HOME_DIR/.cache"      "$USR_HOME/"
else
    echo
    echo "Okay, skipping config files."
fi
for f in .Xresources .conkyrc .conkyrc.bak .bashrc .xprofile; do
    [[ -f "$HOME_DIR/$f" ]] && cp -a "$HOME_DIR/$f" "$USR_HOME/"
done
sleep 1

# --------------------- Fix permissions -----------------------------
echo
echo "Making sure ownership is correct..."
chown -R "$usrnme:$usrnme" "$USR_HOME"
sleep 1

# --------------------- Add user to sudo --------------------------
log "Adding $usrnme to sudo"
sleep 1
SUDO_NM_FL="$INST_PTH/etc/sudoers.d/$usrnme"
cat <<EOF > "$SUDO_NM_FL"  &>/dev/null
$usrnme        ALL=(ALL:ALL) ALL

Defaults    env_keep+="HOME"

Defaults timestamp_timeout=-1
EOF
# 1. Set the correct ownership (usually root:root)
chown root:root "$SUDO_NM_FL"

# 2. Set the correct permissions (Read-only for owner and group, nothing for others)
chmod 0440 "$SUDO_NM_FL"

# --------------------- Final pause ---------------------------------
echo
log "Almost done! You can now:
        • Open another terminal and chroot in: sudo chroot $INST_PTH
        • Inspect the filesystem in your file manager"
echo
echo
read -rsp "Removing junk files and preparing to build you live ISO.

Press ENTER when ready to build the live ISO..."
rm -rf "$INST_PTH/work"
rm -rf "$INST_PTH/usr/share/doc/*"
rm -rf "$INST_PTH/usr/share/man/*"
rm -rf "$INST_PTH//var/cache/apt/archives/*"
rm -rf "$INST_PTH/tmp/*"
rm -rf "$INST_PTH/var/tmp/*"

# --------------------- Build the live ISO --------------------------
echo
log "Building the live ISO..."
"$LIVE_BUILD_SCRIPT"   # ← your clean live-ISO script from earlier

# --------------------- Clean unmount -------------------------------
echo
log "Unmounting everything..."
sleep 1
umount "$INST_PTH"/{proc,sys,dev/pts,dev} 2>/dev/null || true
umount "$INST_PTH" 2>/dev/null || true

# Remount host /boot if it was mounted before
if blkid | grep -iq "boot"; then
    boot_dev=$(blkid | grep -i "boot" | awk '{print $1}' | tr -d ':')
    mount "$boot_dev" /boot 2>/dev/null || true
fi

# --------------------- Finished! -----------------------------------
echo
echo "============================================================"
echo "                     ALL DONE!"
echo "============================================================"
echo "Your live ISO is ready in: $HOME_DIR/MSI_live-build/"
echo "Install it by:"
echo "   Primary system:
Wipe first:
    sudo dd if=/dev/zero of=/dev/sdX bs=1M count=10 status=progress oflag=direct
Write file:
    sudo dd if=MSI_live-image-amd64.hybrid.iso of=/dev/sdX bs=4M status=progress oflag=sync"
echo "   Secondary system: Put it in a folder on you device and reference it with /etc/grub.d/40_custom OR by running your other scripts: debian-instal-usb-prep, then installing manually via drag and drop."
echo "Enjoy your fully personalized Debian MATE live system!"
echo "============================================================"
