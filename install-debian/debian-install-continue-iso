#!/usr/bin/env bash
# ===================================================================
# debian-install-continue-iso – Chroot Finalizer for MSI Live Build
# Clean, Safe & Fast Edition – 2025
# ===================================================================
set -euo pipefail
IFS=$'\n\t'
# ------Reference: If a line has ' || true' at the end, it means the script will keep running(NOT CRITITCAL COMMANDS). Used with the 'set -e' command above which stops the entire scripts if errors.
# -------------------------- Config ----------------------------------
PACKLIST="/my_packs.list.chroot"          # Your big package list
TIMEZONE="America/Chicago"                # Change if needed
LOCALE="en_US.UTF-8"

# ------------------------Custom Helper Functions -------------------------
log()    { echo -e "\n\033[1;36m==>\033[0m \033[1;33m$*\033[0m\n"; }
error()  { echo -e "\033[1;31mERROR: $*\033[0m" >&2; exit 1; }
ask()    { read -rp "$1 [y/N] " ans; [[ "$ans" =~ ^[yY]|[yY][eE][sS]$ ]]; }

# -------------------------- Main ------------------------------------
log "Updating package lists and upgrading base system"
sleep 1
apt update
apt upgrade -y

log "Installing base tools & utilities"
sleep 1
apt install -y --no-install-recommends \
    xterm bash-completion ncurses-term

export TERM=xterm-color

# -------------------------- Locale & Timezone ----------------------
log "Configuring timezone → $TIMEZONE"
sleep 1
apt install -y --no-install-recommends \
     wget nano zstd pv git fzf curl fastfetch dialog gnupg2 software-properties-common jshon ca-certificates locales

ln -sf "/usr/share/zoneinfo/$TIMEZONE" /etc/localtime
echo "$TIMEZONE" > /etc/timezone
DEBIAN_FRONTEND=noninteractive dpkg-reconfigure tzdata

log "Enabling $LOCALE locale"
sleep 1
# Ensure the directory exists
mkdir -p /etc/default

# Create a proper locale.gen if it doesn't exist yet
if [[ ! -f /etc/locale.gen ]]; then
    echo "$LOCALE UTF-8" > /etc/locale.gen
else
    # If it exists, just make sure our locale is uncommented
    sed -i "/^#$LOCALE UTF-8/c\\$LOCALE UTF-8" /etc/locale.gen
    # Or simpler: just append if not present
    grep -q "^$LOCALE UTF-8" /etc/locale.gen || echo "$LOCALE UTF-8" >> /etc/locale.gen
fi

# Set default locale
echo "LANG=$LOCALE" > /etc/default/locale

# Generate locales
locale-gen
DEBIAN_FRONTEND=noninteractive dpkg-reconfigure locales

# -------------------------- Kernel & Firmware ----------------------
log "Installing latest kernel and firmware"
sleep 1
apt install -y --no-install-recommends \
    linux-image-amd64 linux-headers-amd64 \
    firmware-linux firmware-linux-nonfree firmware-misc-nonfree || true

# -------------------------- Your big package list ------------------
log "Installing your custom package selection"
sleep 1
if [[ -f "$PACKLIST" ]]; then
    echo "Scanning packages, hold please..."
    cat "$PACKLIST" | xargs apt list 2>/dev/null < "$PACKLIST" | awk -F'/' '/\//{print $1}' | xargs apt install -y
    #apt install -y $(grep -vE "^\s*($|#)" "$PACKLIST")
else
    error "Package list not found: $PACKLIST"
fi

# -------------------------- Root password --------------------------
log "Setting root password"
sleep 1
while true; do
    echo -n "Enter new root password: "
    read -rs passwd1; echo
    echo -n "Confirm root password: "
    read -rs passwd2; echo
    if [[ "$passwd1" == "$passwd2" && -n "$passwd1" ]]; then 
        break
    fi
    echo -e "\033[1;31mPasswords do not match or empty. Try again.\033[0m"
done
echo "root:$passwd1" | chpasswd
echo "$passwd1" > /passwd.txt
# -------------------------- Create main user ----------------------
log "Creating your live user"
sleep 1
while true; do
    echo -n "Enter username: "
    read username
    if id "$username" &>/dev/null; then
        echo "User already exists. Choose another."
    elif [[ -z "$username" ]]; then
        echo "Username cannot be empty."
    else
        break
    fi
done

while true; do
    echo -n "Enter password for $username: "
    read -rs passwd1; echo
    echo -n "Confirm password: "
    read -rs passwd2; echo
    if [[ "$passwd1" == "$passwd2" && -n "$passwd1" ]]; then
        break
    fi
    echo -e "\033[1;31mPasswords do not match or empty. Try again.\033[0m"
done

adduser --disabled-password --gecos "" "$username"
echo "$username:$passwd1" | chpasswd
usermod -aG sudo,adm,cdrom,floppy,audio,dip,video,plugdev,netdev "$username"

# Save username for the outer script
echo "$username" > /usrnme.txt

# -------------------------- Latest non-free firmware (testing) ----
log "Installing latest unofficial non-free firmware (testing)"
sleep 1
mkdir -p /tmp/firmware && cd /tmp/firmware
wget http://cdimage.debian.org/cdimage/unofficial/non-free/firmware/testing/current/firmware.tar.gz
tar -xzf firmware.tar.gz
dpkg -i ./*.deb || apt install -f -y  # fix any missing deps
cd /; rm -rf /tmp/firmware

#---------------Install lates google chrome--------------------------
log "Installing latest Google Chrome Stable on system"
sleep 1
/bin/sh /google-chrome-latest-install || true
rm google* || true
# -------------------------- Final cleanup --------------------------
log "Final system upgrade & cleanup"
sleep 1
apt upgrade -y
apt full-upgrade -y || true
apt --fix-broken install -y || true
apt autoremove -y
apt clean

# Remove annoying screensaver if present
apt purge -y mate-screensaver 2>/dev/null || true

# Install GRUB (needed for live-build later)
apt install -y --no-install-recommends grub2

log "Chroot setup complete! Returning to host script..."
sleep 1
exit 0
