#!/usr/bin/env bash
# WARNING: This script will WIPE ALL DATA on the target disk ($TARGET_DISK)!
# Ensure $TARGET_DISK is set correctly (e.g., /dev/sda)!
set -euo pipefail
IFS=$'\n\t'

# -------------------------- Config ---------------------------------#
export HOME_DIR="$HOME"
INST_PTH="$HOME_DIR/tmp/deb-inst"
CONFIGS_DIR="$HOME_DIR/scripts/install-debian/my_configs"
SCRIPTS_DIR="$HOME_DIR/scripts"
CHROOT_SCRIPT="$SCRIPTS_DIR/debian-install-sngl-prt-continue"
PACKLIST="$CONFIGS_DIR/my_packs.list.chroot"
GOOGLE_CHRM_SCRIPT="$HOME_DIR/scripts/google-chrome-latest-install"

# -------------------------- Helpers -------------------------------#
log()   { echo -e "\n\033[1;36m==>\033[0m \033[1;33m$*\033[0m\n"; sleep 1; }
error() { echo -e "\033[1;31mERROR: $*\033[0m" >&2; exit 1; }
ask()   { read -rp "$1[y/N]: " ans; [[ "$ans" =~ ^[yY]|[yY][eE][Ss]$ ]]; }
# -------------------------- Must be root --------------------------#
[[ "$EUID" -eq 0 ]] || error "This script must be run as root!"

#---------------------Explanation---------------------------------------#
clear
log "This is for insalling Debian to a single partition on a system that already has a running Linux system. Not boot partitions, or grub install. System will be read from grub os-prober from existing OS."
if ! ask "Would you like to continue?"; then
	echo
	echo "Exiting script"
	exit 0
fi
lsblk
echo
read -rp "Please type the FULL partition to install Debian to(ex. /dev/sda4, /dev/sda2, /dev/sdb3): " TARGET_DISK

log "Formatting the Root partition ($TARGET_DISK) as ext4..."
mkfs.ext4 -L "DEBIAN_ROOT" "$TARGET_DISK"
sync
sleep 1

# 3. Mount the new partitions
log "Mounting the Root partition to the installation path ($INST_PTH)..."
mkdir -p "$INST_PTH"
mount "$TARGET_DISK" "$INST_PTH"

log "Current mounts after partitioning and formatting:"
lsblk -f
sleep 1

# -------------------------- Install latest debootstrap (YOUR WAY) ---
log "Downloading latest debootstrap"
sleep 1
mkdir -p "$INST_PTH/work"
cd "$INST_PTH/work"

DEBOOT_STRP=$(wget -qO- http://ftp.debian.org/debian/pool/main/d/debootstrap | grep "all.deb" | sort -V | tail -1 | sed -e 's:.*a href="::' -e 's:.>.*::')

wget "http://ftp.debian.org/debian/pool/main/d/debootstrap/$DEBOOT_STRP"
dpkg -i "$DEBOOT_STRP" >/dev/null
sleep 1

log "Running debootstrap (this takes 5–15 minutes)"
#Show curretn mount pouints
log "Current mounts:"
lsblk -f
sleep 1
#Start debian base install
debootstrap --arch=amd64 \
    --components=main,contrib,non-free,non-free-firmware \
    testing "$INST_PTH" http://deb.debian.org/debian/
sleep 1

# -------------------------- Mounts & network ----------------------#
log "Mounting system directories"
sleep 1
mount -t proc  none   "$INST_PTH/proc"
mount -t sysfs none   "$INST_PTH/sys"
mount -o bind  /dev   "$INST_PTH/dev"
mount -o bind  /dev/pts "$INST_PTH/dev/pts"

# --------------------- Network configuration ---------------------#
log "Setting up basic networking"
sleep 1
# 1. Copy current resolv.conf so DNS works inside chroot
cp -f /etc/resolv.conf "$INST_PTH/etc/resolv.conf"

# 2. Copy hosts and hostname (helps with some tools)
cp -f /etc/hosts     "$INST_PTH/etc/hosts"
cp -f /etc/hostname  "$INST_PTH/etc/hostname"

# 3. Traditional /etc/network/interfaces (still used by live-boot + ifupdown)
if [[ -f /etc/network/interfaces ]]; then
    install -Dm644 /etc/network/interfaces "$INST_PTH/etc/network/interfaces"
else
    # Fallback: create a minimal working one
    cat > "$INST_PTH/etc/network/interfaces" <<EOF
# Used by live-boot and ifupdown
auto lo
iface lo inet loopback

auto eth0
iface eth0 inet dhcp
EOF
fi

# --------------------- Fix apt sources (critical!) ---------------#
log "Fixing apt sources configuration"
sleep 1
# Remove legacy sources.list if it exists (testing still creates it)
if [[ -f "$INST_PTH/etc/apt/sources.list" ]]; then
    rm -f "$INST_PTH/etc/apt/sources.list"
    echo "Removed old /etc/apt/sources.list"
    sleep 1
fi
# Ensure sources.list.d directory exists
mkdir -p "$INST_PTH/etc/apt/sources.list.d"

# 'instal' line explained: shortcut for copying with correct permissions and create directories if they don't exist.
# Copy sources and pinning
rsync -a --progress /etc/apt/ "$INST_PTH/etc/apt/"
install -Dm644 "$CONFIGS_DIR/my_preferences.pref"      "$INST_PTH/etc/apt/preferences.d/"
find "$INST_PTH/etc/apt/sources.list.d/" -maxdepth 1 \( -name "*mega*" -o -name "*google*" \) -exec rm -v {} \;
# Copy helper scripts
install -Dm755 "$CHROOT_SCRIPT"                        "$INST_PTH/debian-install-continue"
install -Dm644 "$CONFIGS_DIR/my_packs.list.chroot"     "$INST_PTH/my_packs.list.chroot"
install -Dm755 "$GOOGLE_CHRM_SCRIPT"                   "$INST_PTH/google-chrome-latest-install" 

# -------------------------- Chroot & finish ----------------------#
log "Entering chroot to complete installation"
sleep 1
# exporting TARGET_DISK var to second script
chroot $INST_PTH /bin/bash -i -c "export TARGET_DISK='$TARGET_DISK'; source /debian-install-continue"

# Cleanup chroot helpers
rm -f "$INST_PTH"/{debian-install-continue,my_packs.list.chroot}

# -------------------------- Handle separate partitions ------------#
# Clear existing fstab or add a header
echo "			###### msifland custom install script ######" > "$INST_PTH/etc/fstab" || true
echo "" >> "$INST_PTH/etc/fstab" || true
echo "" >> "$INST_PTH/etc/fstab" || true
echo "UUID=#####UUID HERE#####  / ext4 defaults,errors=remount-ro	0   1" >> "$INST_PTH/etc/fstab" || true

# --- Add the EFI partition ---
echo
echo "Add new partition to fstab"
sleep 1
lsblk
sudo nano "$INST_PTH/etc/fstab"

# -------------------------- Copy user data ------------------------#
usrnme=$(cat "$INST_PTH/usrnme.txt" 2>/dev/null || echo "user")
rm -f "$INST_PTH"/{usrnme.txt,usrnme_psswrd.txt,new_psswrd.txt}
USR_HOME="$INST_PTH/home/$usrnme"

# Create standard dirs
for d in Desktop Downloads Music Pictures Videos tmp Wallpapers; do
    mkdir -p "$USR_HOME/$d"
done

# --------------------- Copy personal files (optional) ------------#
cp "$HOME_DIR/scripts/git-clone-my-repos" "$USR_HOME/git-clone-my-repos"
read -rp "Would you like to add you git directories(Document, scripts, pkg_bkups, etc.)[y/N]: " add_docs
if [[ "$add_docs" =~ ^[yY]|[yY][eE][sS]$ ]]; then
    echo "Copying personal files using git clone..."
    cd $USR_HOME
    /bin/bash git-clone-my-repos
    rm -f "git-clone-my-repos"
    cd "$INST_PTH"
    echo
    echo "Done cloning pernal git repos"
else
    echo
    echo "Okay, skipping personal docs."
fi
sleep 1

# --------------------- Copy dotfiles/configs (optional) ----------#
read -rp "Would you like to add you config files(.conig, .local, .cache, etc.)[y/N]: " add_confs
if [[ "$add_confs" =~ ^[yY]|[yY][eE][sS]$ ]]; then
    echo "Copying configuration files..."
    rsync -a --progress --exclude={chrome-remote-desktop,chromium,google-chrome,skypeforlinux,Code,variety} \
        "$HOME_DIR/.config"     "$USR_HOME/"
    rsync -a --progress --exclude={share/applications,share/baloo,share/akonadi,share/logs,share/lutris,share/skypeweb,share/Steam,share/Trash} \
        "$HOME_DIR/.local"      "$USR_HOME/"
    rsync -a --progress --exclude={chromium,mozilla,tracker,wine*,google-chrome,at-spi*} \
        "$HOME_DIR/.cache"      "$USR_HOME/"
else
    echo
    echo "Okay, skipping config files."
fi
for f in .Xresources .conkyrc .conkyrc.bak .bashrc .xprofile; do
    [[ -f "$HOME_DIR/$f" ]] && cp -a "$HOME_DIR/$f" "$USR_HOME/"
done
sleep 1

# --------------------- Fix permissions ----------------------------#
chown -R "$usrnme:$usrnme" "$USR_HOME"
sleep 1

# --------------------- Add user to sudo -------------------------#
log "Adding $usrnme to sudo"
sleep 1
SUDO_NM_FL="$INST_PTH/etc/sudoers.d/$usrnme"
cat <<EOF > "$SUDO_NM_FL"  &>/dev/null
$usrnme        ALL=(ALL:ALL) ALL

Defaults    env_keep+="HOME"

Defaults timestamp_timeout=-1
EOF
sleep 1

log "Setting correct sudo permissions to files for $usrnme"
# 1. Set the correct ownership (usually root:root)
chown root:root "$SUDO_NM_FL"

# 2. Set the correct permissions (Read-only for owner and group, nothing for others)
chmod 0440 "$SUDO_NM_FL"

# --------------------- Final pause --------------------------------#
echo
log "Almost done! You can now:
        • Open another terminal and chroot in: sudo chroot $INST_PTH
        • Inspect the filesystem in your file manager"
echo
echo
read -rsp "Press ENTER when ready to clean up and finalize..."
rm -rf "$INST_PTH/work"
rm -rf "$INST_PTH/usr/share/doc/*"
rm -rf "$INST_PTH/usr/share/man/*"
rm -rf "$INST_PTH//var/cache/apt/archives/*"
rm -rf "$INST_PTH/tmp/*"
rm -rf "$INST_PTH/var/tmp/*"

# Final clean  up
log "Final clean up before build is complete"
# Remove uneeded apt sources
find "$INST_PTH/etc/apt/sources.list.d/" -maxdepth 1 -name "*mega*" -exec rm -v {} \;
chroot $INST_PTH /bin/bash -c "apt update -y || true; apt upgrade -y || true; apt full-upgrade -y || true;apt --fix-broken install -y || true; apt autopurge -y || true; apt autoclean -y || true; apt clean -y || true; exit"

echo
log "Installation complete! Unmounting..."
sleep 1
mapfile -t mounted < <(lsblk -nrp -o NAME,MOUNTPOINT "$TARGET_DISK" | grep -v '^$')
for mnt in "${mounted[@]}"; do
    umount "${mnt%% *}" 2>/dev/null || true
done
umount "$INST_PTH"/{proc,sys,dev/pts,dev} 2>/dev/null || true
umount "$INST_PTH"/* 2>/dev/null || true
umount "$INST_PTH" 2>/dev/null || true
sleep 1

log "ALL DONE!"
sleep 1
echo "You can now reboot and boot from $TARGET_DISK"
echo "Your username: $usrnme"
echo "Enjoy your brand new personalized Debian MATE system!"
sleep 1
