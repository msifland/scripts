#!/bin/bash
# =============================================================================
# System Update & Backup Script
# Cleans, updates, and backs up packages, apt sources, configs, and crontab
# =============================================================================

set -euo pipefail

BACKUP_DIR="$HOME/pkg_bkups"
BACKUP_CONFIG_DIR="$BACKUP_DIR/backups"
MAX_BACKUPS=4

# Files to back up from home
CONFIG_FILES=(".bashrc" ".bash_profile" ".blerc" ".conkyrc" ".conkyrc.bak" 
              ".nanorc" ".xprofile" ".Xresources")

# Start timing
clear
echo -e "${ILCOLOR4}########### Starting System Update & Backup ###########${ILRESTORE}"
echo -e "${ILCOLOR2}$(date '+%m-%d-%Y %r')${ILRESTORE}\n"
START_TIME=$(date +%s)

# Keep sudo alive
echo 'spike' | sudo -S -v
while true; do sudo -n true; sleep 60; kill -0 "$$" || exit; done 2>/dev/null &

echo -e "${ILCOLOR3}Updating system information...${ILRESTORE}"
echo "Running on: $(uname -a)"
sleep 1

# =============================================================================
# 1. System Update
# =============================================================================
echo -e "\n${ILCOLOR1}Updating package lists...${ILRESTORE}"
sudo apt update

echo -e "\n${ILCOLOR1}Upgrading installed packages...${ILRESTORE}"
sudo apt upgrade -y --allow-downgrades
sudo apt full-upgrade -y --allow-downgrades

echo -e "\n${ILCOLOR1}Cleaning up...${ILRESTORE}"
sudo apt autopurge -y
sudo apt clean
sudo apt autoclean

# Remove configuration files from uninstalled packages
echo -e "${ILCOLOR1}Purging residual config files...${ILRESTORE}"
sudo dpkg -l | awk '/^rc/ {print $2}' | xargs -r sudo apt purge -y

# Clear thumbnail cache
echo -e "${ILCOLOR1}Clearing thumbnail cache...${ILRESTORE}"
rm -rf ~/.cache/thumbnails/*/*
rm -rf ~/.thumbnails/*/* 2>/dev/null || true

# =============================================================================
# 2. Create backup directories
# =============================================================================
mkdir -p "$BACKUP_DIR/apt" "$BACKUP_CONFIG_DIR"

# =============================================================================
# 3. Backup installed package list (rotate old ones)
# =============================================================================
echo -e "\n${ILCOLOR1}Backing up installed package list...${ILRESTORE}"
PKG_LIST="$BACKUP_DIR/pkgs.txt"

# Rotate old package lists
for i in $(seq $((MAX_BACKUPS - 1)) -1 1); do
    if [[ -f "$BACKUP_DIR/pkgs.txt.old-$i" ]]; then
        mv "$BACKUP_DIR/pkgs.txt.old-$i" "$BACKUP_DIR/pkgs.txt.old-$((i+1))"
    fi
done
[[ -f "$PKG_LIST" ]] && mv "$PKG_LIST" "$BACKUP_DIR/pkgs.txt.old-1"

dpkg --get-selections | awk '{print $1}' > "$PKG_LIST"

# =============================================================================
# 4. Backup /etc/apt (sources & keys) - rotate folders
# =============================================================================
echo -e "${ILCOLOR1}Backing up APT sources and keys...${ILRESTORE}"

# Rotate old apt backups
for i in $(seq $((MAX_BACKUPS - 1)) -1 1); do
    if [[ -d "$BACKUP_DIR/apt.old-$i" ]]; then
        rm -rf "$BACKUP_DIR/apt.old-$((i+1))"
        mv "$BACKUP_DIR/apt.old-$i" "$BACKUP_DIR/apt.old-$((i+1))"
    fi
done
[[ -d "$BACKUP_DIR/apt" ]] && mv "$BACKUP_DIR/apt" "$BACKUP_DIR/apt.old-1"

mkdir -p "$BACKUP_DIR/apt"
cp -a /etc/apt/{sources.list,sources.list.d,trusted.gpg*} "$BACKUP_DIR/apt/" 2>/dev/null || true

# =============================================================================
# 5. Backup important config files
# =============================================================================
echo -e "\n${ILCOLOR1}Backing up personal configuration files...${ILRESTORE}"
for file in "${CONFIG_FILES[@]}"; do
    [[ -f "$HOME/$file" ]] && cp -f "$HOME/$file" "$BACKUP_CONFIG_DIR/" && \
        echo "  Backed up ~/$file"
done
sudo cp /etc/ssh/sshd_config "$BACKUP_CONFIG_DIR/"
echo "  Backup up sshd_config"

# =============================================================================
# 6. Backup crontab (user + root if exists)
# =============================================================================
echo -e "\n${ILCOLOR1}Backing up crontab...${ILRESTORE}"
if crontab -l &>/dev/null; then
    crontab -l > "$BACKUP_CONFIG_DIR/cron-jobs.txt"
    echo "  User crontab saved"
fi

if sudo crontab -l &>/dev/null; then
    sudo crontab -l > "$BACKUP_CONFIG_DIR/cron-jobs-SUDO.txt"
    echo "  Root crontab saved"
fi

# =============================================================================
# 7. Backup fstab
# =============================================================================
echo -e "\n${ILCOLOR1}Backing up /etc/fstab...${ILRESTORE}"
cp -f /etc/fstab "$BACKUP_CONFIG_DIR/fstab"

# =============================================================================
# 8. Update local git repos (optional script)
# =============================================================================
if [[ -x "$HOME/scripts/git-update" ]]; then
    echo -e "\n${ILCOLOR2}Updating local git repositories...${ILRESTORE}"
    "$HOME/scripts/git-update" && echo -e "${ILCOLOR3}Git update successful${ILRESTORE}" \
                               || echo -e "${ILCOLOR1}Git update failed${ILRESTORE}"
else
    echo -e "\n${ILCOLOR3}git-update script not found or not executable â€” skipping${ILRESTORE}"
fi

# =============================================================================
# Finish
# =============================================================================
END_TIME=$(date +%s)
DURATION=$((END_TIME - START_TIME))

echo -e "\n${ILCOLOR2}$(date '+%m-%d-%Y %r')${ILRESTORE}"
echo -e "${ILCOLOR2}System update and backup completed in ${DURATION} seconds "
echo -e "        ($((DURATION / 60)) minutes and $((DURATION % 60)) seconds)${ILRESTORE}"
echo -e "${ILCOLOR4}All done!${ILRESTORE}\n"

exit 0
