#!/usr/bin/env bash
# ===================================================================
# debian-install-continue – Chroot Finalizer for Full Disk Install
# Your Style + All sleep + All Original Methods – 2025
# ===================================================================
set -euo pipefail
IFS=$'\n\t'

# Simple colored logger with your favorite pause
log() { echo -e "\n\033[1;36m==>\033[0m \033[1;33m$*\033[0m\n"; sleep 1; }
# -------------------------- Main ------------------------------------
log "Updating package lists and upgrading base system"
sleep 1
apt update
apt upgrade -y

log "Installing base tools & utilities"
sleep 1
apt install -y --no-install-recommends \
    xterm bash-completion ncurses-term

export TERM=xterm-color

# -------------------------- Locale & Timezone ----------------------
log "Configuring timezone → $TIMEZONE"
sleep 1
apt install -y --no-install-recommends \
     wget nano zstd pv git fzf curl screenfetch dialog gnupg2 software-properties-common jshon ca-certificates locales

ln -sf "/usr/share/zoneinfo/$TIMEZONE" /etc/localtime
echo "$TIMEZONE" > /etc/timezone
DEBIAN_FRONTEND=noninteractive dpkg-reconfigure tzdata

log "Enabling $LOCALE locale"
sleep 1
# Ensure the directory exists
mkdir -p /etc/default

# Create a proper locale.gen if it doesn't exist yet
if [[ ! -f /etc/locale.gen ]]; then
    echo "$LOCALE UTF-8" > /etc/locale.gen
else
    # If it exists, just make sure our locale is uncommented
    sed -i "/^#$LOCALE UTF-8/c\\$LOCALE UTF-8" /etc/locale.gen
    # Or simpler: just append if not present
    grep -q "^$LOCALE UTF-8" /etc/locale.gen || echo "$LOCALE UTF-8" >> /etc/locale.gen
fi

# Set default locale
echo "LANG=$LOCALE" > /etc/default/locale

# Generate locales
locale-gen
DEBIAN_FRONTEND=noninteractive dpkg-reconfigure locales

# -------------------------- Kernel & Firmware ----------------------
log "Installing latest kernel and firmware"
sleep 1
apt install -y --no-install-recommends \
    linux-image-amd64 linux-headers-amd64 \
    firmware-linux firmware-linux-nonfree firmware-misc-nonfree || true

# -------------------------- Your big package list ------------------
log "Installing your custom package selection"
sleep 1
if [[ -f "$PACKLIST" ]]; then
    apt install -y $(grep -vE "^\s*($|#)" "$PACKLIST")
else
    error "Package list not found: $PACKLIST"
fi

# -------------------------- Root password --------------------------
log "Setting root password"
sleep 1
while true; do
    echo -n "Enter new root password: "
    read -rs passwd1; echo
    echo -n "Confirm root password: "
    read -rs passwd2; echo
    [[ "$passwd1" == "$passwd2" && -n "$passwd1" ]] && break
    echo -e "\033[1;31mPasswords do not match or empty. Try again.\033[0m"
done
echo "root:$passwd1" | chpasswd

# -------------------------- Create main user ----------------------
log "Creating your live user"
sleep 1
while true; do
    echo -n "Enter username: "
    read username
    if id "$username" &>/dev/null; then
        echo "User already exists. Choose another."
    elif [[ -z "$username" ]]; then
        echo "Username cannot be empty."
    else
        break
    fi
done

while true; do
    echo -n "Enter password for $username: "
    read -rs passwd1; echo
    echo -n "Confirm password: "
    read -rs passwd2; echo
    [[ "$passwd1" == "$passwd2" && -n "$passwd1" ]] && break
    echo -e "\033[1;31mPasswords do not match or empty. Try again.\033[0m"
done

adduser --disabled-password --gecos "" "$username"
echo "$username:$passwd1" | chpasswd
usermod -aG sudo,adm,cdrom,floppy,audio,dip,video,plugdev,netdev "$username"

# Save username for the outer script
echo "$username" > /usrnme.txt

# -------------------------- Latest non-free firmware (testing) ----
log "Installing latest unofficial non-free firmware (testing)"
sleep 1
mkdir -p /tmp/firmware && cd /tmp/firmware
wget -q http://cdimage.debian.org/cdimage/unofficial/non-free/firmware/testing/current/firmware.tar.gz
tar -xzf firmware.tar.gz
dpkg -i ./*.deb || apt install -f -y  # fix any missing deps
cd /; rm -rf /tmp/firmware

# -------------------------- Final cleanup --------------------------
log "Final system upgrade & cleanup"
sleep 1
apt upgrade -y
apt full-upgrade -y || true
apt --fix-broken install -y || true
apt autoremove -y
apt clean

# Remove annoying screensaver if present
apt purge -y mate-screensaver 2>/dev/null || true

log "Installing GRUB bootloader packages..."
# We install both sets of binaries so the outer script can choose UEFI or BIOS
apt install -y --no-install-recommends \
    grub2-common grub-pc-bin grub-efi-amd64-bin grub-efi-amd64-signed shim-signed

log "Chroot phase complete – returning to main installer..."
sleep 2
exit 0
