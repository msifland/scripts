#!/bin/bash
# =============================================================================
# WSL (Windows Subsystem for Linux) Update Script
# Safe, minimal, fast — meant to be launched ONLY from: ~/scripts/linux-wsl-update
# =============================================================================

set -euo pipefail

# ----------------------------- Safety Confirmation -------------------------
echo -e "${ILCOLOR2}
                        ┌────────────────────────────────────────────┐
                        │               ⚠️  CAUTION ⚠️               │
                        │ This script must be run from:              │
                        │     ~/scripts/linux-wsl-update             │
                        │                                            │
                        └────────────────────────────────────────────┘${ILRESTORE}"

read -rp "Did you launch this via linux-wsl-update? [Y/n]: " answer
echo

if [[ ! "$answer" =~ ^([yY]|yes|YES|Y)$ ]]; then
    echo -e "${ILCOLOR1}Aborted. Please run this only from linux-wsl-update.${ILRESTORE}"
    exit 1
fi

# ----------------------------- Start ---------------------------------------
clear
echo -e "${ILCOLOR4}########### Updating WSL System ###########${ILRESTORE}"
echo -e "${ILCOLOR2}$(date '+%m-%d-%Y %r')${ILRESTORE}\n"

START_TIME=$(date +%s)

# Keep sudo timestamp fresh (WSL supports sudo without password in most setups,
# but this works either way and avoids hardcoding passwords)
echo 'spike' | sudo -S -v || { echo -e "${ILCOLOR1}Sudo failed — exiting.${ILRESTORE}"; exit 1; }
( while true; do sudo -n true; sleep 60; kill -0 "$$" || exit; done ) 2>/dev/null &

echo -e "${ILCOLOR3}Running on: $(uname -a)${ILRESTORE}\n"

# =============================================================================
# 1. Update package lists
# =============================================================================
echo -e "${ILCOLOR1}Updating package sources...${ILRESTORE}"
sudo apt update

# =============================================================================
# 2. Upgrade all packages
# =============================================================================
echo -e "\n${ILCOLOR1}Upgrading installed packages...${ILRESTORE}"
sudo apt upgrade -y --allow-downgrades
sudo apt full-upgrade -y --allow-downgrades

# =============================================================================
# 3. Clean up
# =============================================================================
echo -e "\n${ILCOLOR1}Cleaning up unused packages and cache...${ILRESTORE}"
sudo apt autopurge -y
sudo apt autoclean
sudo apt clean

# Remove leftover config files from uninstalled packages
if dpkg -l | grep -q '^rc'; then
    echo -e "${ILCOLOR1}Purging residual configuration files...${ILRESTORE}"
    sudo dpkg -l | awk '/^rc/ {print $2}' | xargs -r sudo apt purge -y
fi

# =============================================================================
# 4. Update ble.sh (bash line editor)
# =============================================================================
echo -e "\n${ILCOLOR1}Updating ble.sh...${ILRESTORE}"
if [[ -x "$HOME/scripts/blesh-update" ]]; then
    "$HOME/scripts/blesh-update" && \
        echo -e "  ${ILCOLOR2}ble.sh updated successfully${ILRESTORE}" || \
        echo -e "  ${ILCOLOR1}ble.sh update failed${ILRESTORE}"
else
    echo -e "  ${ILCOLOR3}blesh-update script not found — skipping${ILRESTORE}"
fi

# =============================================================================
# Done
# =============================================================================
END_TIME=$(date +%s)
DURATION=$((END_TIME - START_TIME))
MINUTES=$((DURATION / 60))
SECONDS=$((DURATION % 60))

echo -e "\n${ILCOLOR2}$(date '+%m-%d-%Y %r')${ILRESTORE}"
echo -e "${ILCOLOR2}WSL update completed in ${MINUTES}m ${SECONDS}s${ILRESTORE}"
echo -e "${ILCOLOR4}All done! No errors detected.${ILRESTORE}\n"
