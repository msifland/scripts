#!/bin/bash

# --- Safety Check: Must run as root ---
if [ "$EUID" -ne 0 ]; then
    echo "This script must be run as root. Use 'sudo ./scriptname.sh'"
    exit 1
fi

# --- 1. Identify connected drives ---
echo "Identifying available drives (excluding main hdd partitions):"
lsblk -o NAME,SIZE,TYPE,MOUNTPOINT | grep -E 'disk|usb' | grep -v 'part'

echo ""

# --- 2. Get user input for source and destination ---
read -p "Enter the SOURCE drive (e.g., sdb): " SOURCE_DRIVE_NAME
read -p "Enter the DESTINATION drive (e.g., sdc): " DEST_DRIVE_NAME

SOURCE_DRIVE="/dev/$SOURCE_DRIVE_NAME"
DEST_DRIVE="/dev/$DEST_DRIVE_NAME"

# --- 3. Verify inputs ---
if [ ! -b "$SOURCE_DRIVE" ] || [ ! -b "$DEST_DRIVE" ]; then
    echo "Error: One or both devices do not exist or are not block devices."
    exit 1
fi

echo ""
echo "--- WARNING ---"
echo "This operation will PERMANENTLY ERASE ALL data on $DEST_DRIVE."
echo "Source: $SOURCE_DRIVE (input drive)"
echo "Destination: $DEST_DRIVE (drive to be wiped and cloned to)"
echo "--- WARNING ---"

read -p "Are you absolutely sure you want to proceed? (type 'yes' to continue): " CONFIRMATION

if [ "$CONFIRMATION" != "yes" ]; then
    echo "Operation cancelled by user."
    exit 1
fi

# --- 4. Unmount any mounted partitions of the drives ---
echo "Attempting to unmount any partitions on source and destination drives..."
umount "$SOURCE_DRIVE"* 2>/dev/null
umount "$DEST_DRIVE"* 2>/dev/null
echo "Unmounting complete."

# --- 5. Execute the cloning command (dd) ---
echo "Starting bit-by-bit cloning with dd..."
echo "This may take a long time and will not show progress immediately."
echo ""

if ! command -v ddrescue &> /dev/null; then
    log "ddrescue is not installed. Attempting to install using apt..."
    sudo apt update && sudo apt install -y ddrescue gddrescue || error "Failed to install ddrescue and gddrescue. Please install it manually."
fi

sudo ddrescue -f "$SOURCE_DRIVE" "$DEST_DRIVE" "$HOME/tmp/rescue.log"
#sudo dd if="$SOURCE_DRIVE" of="$DEST_DRIVE" bs=4M status=progress conv=fsync

echo
echo "Mounting partitons to update fstab"
sleep 1
sudo mount "${DEST_DRIVE}4" "$HOME/tmp/cloned" --mkdir
sudo mount "${DEST_DRIVE}3" "$HOME/tmp/cloned/boot" --mkdir
sudo mount "${DEST_DRIVE}5" "$HOME/tmp/cloned/home" --mkdir
sudo mount "${DEST_DRIVE}6" "$HOME/tmp/cloned/misc" --mkdir
sudo mount "${DEST_DRIVE}2" "$HOME/tmp/cloned/boot/efi" --mkdir

echo
echo "Show partitions with UUID's"
sleep 1
lsblk "${DEST_DRIVE}" -f -o NAME,SIZE,TYPE,MOUNTPOINT,UUID

echo
echo "Opening fstad to add in UUID's"
sudo subl "$HOME/tmp/cloned/etc/fstab"

echo
echo "Running chroot grub-mkconfig -o /boot/grub/grub.cfg"
sudo chroot "$HOME/tmp/cloned" /bin/bash -c "grub-mkconfig -o /boot/grub/grub.cfg; exit"
sleep 1
echo ""
echo "Cloning complete! Unmounting..."
sudo umount -R "$HOME/tmp/cloned/boot/efi"
sudo umount -R "$HOME/tmp/cloned/boot"
sudo umount -R "$HOME/tmp/cloned/home"
sudo umount -R "$HOME/tmp/cloned/misc"
sudo umount -R "$HOME/tmp/cloned"
sleep 1
echo "You can now safely remove both USB drives."
