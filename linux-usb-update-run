#!/bin/bash
# =============================================================================
# USB Live System Update Script
# Updates system, pulls latest configs from main backups, pushes USB backups
# Should only be run from: ~/scripts/linux-usb-update
# =============================================================================

set -euo pipefail

# ----------------------------- Config --------------------------------
MAIN_BACKUP_DIR="$HOME/pkg_bkups/backups"
USB_BACKUP_DIR="$HOME/usb_pkg_bkups"
USB_BACKUP_CONFIG_DIR="$USB_BACKUP_DIR/backups"
MAX_BACKUPS=3

# Files to sync from main backup → live home
CONFIG_FILES_TO_SYNC=(
    ".bashrc"
    ".bash_profile"
    ".blerc"
    ".conkyrc"
    ".nanorc"
    ".Xresources"
)

# ----------------------------- Safety Check --------------------------
clear
echo -e "${ILCOLOR2}
                        ┌────────────────────────────────────────────┐
                        │           ⚠️  CAUTION ⚠️                     │
                        │ This script should ONLY be run from:       │
                        │     ~/scripts/linux-usb-update             │
                        │                                            │
                        └────────────────────────────────────────────┘${ILRESTORE}"

read -rp "Have you launched this via linux-usb-update? [Y/n]: " answer
echo

if [[ ! "$answer" =~ ^([yY]|[Yy][eE][sS])$ ]]; then
    echo -e "${ILCOLOR1}Aborted. Run this only from linux-usb-update.${ILRESTORE}"
    exit 1
fi

# ----------------------------- Start Timing -------------------------
clear
echo -e "${ILCOLOR4}########### Updating USB Live System ###########${ILRESTORE}"
echo -e "${ILCOLOR2}$(date '+%m-%d-%Y %r')${ILRESTORE}\n"

START_TIME=$(date +%s)

# Keep sudo alive for the duration
echo 'spike' | sudo -S -v
( while true; do sudo -n true; sleep 60; kill -0 "$$" || exit; done ) 2>/dev/null &

echo -e "${ILCOLOR3}Running on: $(uname -a)${ILRESTORE}\n"

# =============================================================================
# 1. System Update
# =============================================================================
echo -e "${ILCOLOR1}Updating package lists...${ILRESTORE}"
sudo apt update

echo -e "\n${ILCOLOR1}Upgrading packages...${ILRESTORE}"
sudo apt upgrade -y --allow-downgrades
sudo apt full-upgrade -y --allow-downgrades

echo -e "\n${ILCOLOR1}Cleaning up...${ILRESTORE}"
sudo apt autoremove -y
sudo apt clean
sudo apt autoclean

# Purge removed packages' config files
if dpkg -l | grep -q '^rc'; then
    echo -e "${ILCOLOR1}Removing residual config files...${ILRESTORE}"
    sudo dpkg -l | awk '/^rc/ {print $2}' | xargs -r sudo apt purge -y
fi

# Clear thumbnail cache
echo -e "${ILCOLOR1}Clearing thumbnail caches...${ILRESTORE}"
rm -rf ~/.cache/thumbnails/*/* ~/.thumbnails/*/* 2>/dev/null || true

# =============================================================================
# 2. Prepare USB backup directory
# =============================================================================
mkdir -p "$USB_BACKUP_DIR/apt" "$USB_BACKUP_CONFIG_DIR"

# =============================================================================
# 3. Backup current package list (with rotation)
# =============================================================================
echo -e "\n${ILCOLOR1}Backing up installed package list...${ILRESTORE}"
PKG_LIST="$USB_BACKUP_DIR/pkgs.txt"

# Rotate old backups
for i in $(seq $((MAX_BACKUPS - 1)) -1 1); do
    [[ -f "$USB_BACKUP_DIR/pkgs.txt.old-$i" ]] && \
        mv "$USB_BACKUP_DIR/pkgs.txt.old-$i" "$USB_BACKUP_DIR/pkgs.txt.old-$((i+1))"
done
[[ -f "$PKG_LIST" ]] && mv "$PKG_LIST" "$USB_BACKUP_DIR/pkgs.txt.old-1"

dpkg --get-selections | awk '{print $1}' > "$PKG_LIST"

# =============================================================================
# 4. Backup /etc/apt sources (with rotation)
# =============================================================================
echo -e "\n${ILCOLOR1}Backing up APT sources and keys...${ILRESTORE}"

for i in $(seq $((MAX_BACKUPS - 1)) -1 1); do
    [[ -d "$USB_BACKUP_DIR/apt.old-$i" ]] && \
        rm -rf "$USB_BACKUP_DIR/apt.old-$((i+1))" && \
        mv "$USB_BACKUP_DIR/apt.old-$i" "$USB_BACKUP_DIR/apt.old-$((i+1))"
done

[[ -d "$USB_BACKUP_DIR/apt" ]] && mv "$USB_BACKUP_DIR/apt" "$USB_BACKUP_DIR/apt.old-1"
mkdir -p "$USB_BACKUP_DIR/apt"
cp -a /etc/apt/{sources.list,sources.list.d,trusted.gpg*} "$USB_BACKUP_DIR/apt/" 2>/dev/null || true

# =============================================================================
# 5. Sync latest configs from main backup → live system
# =============================================================================
echo -e "\n${ILCOLOR1}Updating personal config files from main backup...${ILRESTORE}"
for file in "${CONFIG_FILES_TO_SYNC[@]}"; do
    src="$MAIN_BACKUP_DIR/$file"
    dest="$HOME/$file"
    if [[ -f "$src" ]]; then
        cp -f "$src" "$dest" && echo "  → Updated ~/$file"
    else
        echo "  ⚠️  $file not found in main backup (skipped)"
    fi
done

# Backup current .xprofile to USB backup
[[ -f "$HOME/.xprofile" ]] && cp -f "$HOME/.xprofile" "$USB_BACKUP_CONFIG_DIR/.xprofile"

# =============================================================================
# 6. Backup crontab (if exists)
# =============================================================================
echo -e "\n${ILCOLOR1}Backing up user crontab...${ILRESTORE}"
if crontab -l &>/dev/null; then
    crontab -l > "$USB_BACKUP_CONFIG_DIR/cron-jobs.txt"
    echo "  User crontab saved"
fi

# =============================================================================
# 7. Update external tools
# =============================================================================
echo -e "\n${ILCOLOR1}Updating ble.sh...${ILRESTORE}"
if [[ -x "$HOME/scripts/blesh-update" ]]; then
    "$HOME/scripts/blesh-update" && echo "  ble.sh updated" || echo "  ble.sh update failed"
else
    echo "  blesh-update script not found"
fi

echo -e "\n${ILCOLOR1}Updating Sublime Text...${ILRESTORE}"
if [[ -x "$HOME/scripts/subl-update" ]]; then
    "$HOME/scripts/subl-update" && echo "  Sublime Text updated" || echo "  Sublime Text update failed"
else
    echo "  subl-update script not found"
fi

# =============================================================================
# 8. Commit & Push USB backup to GitHub
# =============================================================================
if [[ -d "$USB_BACKUP_DIR/.git" ]]; then
    echo -e "\n${ILCOLOR1}Pushing usb_pkg_bkups to GitHub...${ILRESTORE}"
    cd "$USB_BACKUP_DIR"
    git add --all
    git commit -m "USB update: $(date '+%Y-%m-%d %H:%M')" || echo "  Nothing to commit"
    if git push origin master; then
        echo -e "  ${ILCOLOR2}Successfully pushed to GitHub${ILRESTORE}"
    else
        echo -e "  ${ILCOLOR1}Git push failed${ILRESTORE}"
    fi
else
    echo -e "\n${ILCOLOR3}Warning: usb_pkg_bkups is not a git repo — skipping push${ILRESTORE}"
fi

# =============================================================================
# Done
# =============================================================================
END_TIME=$(date +%s)
DURATION=$((END_TIME - START_TIME))

echo -e "\n${ILCOLOR2}$(date '+%m-%d-%Y %r')${ILRESTORE}"
echo -e "${ILCOLOR2}USB system update completed in $((DURATION / 60)) min $((DURATION % 60)) sec${ILRESTORE}"
echo -e "${ILCOLOR4}All done! Review output above for any warnings.${ILRESTORE}\n"
