#!/bin/bash
# ============================================================================
# Linux Chroot Rescue / Repair Script
# Mounts a broken or live system into /mnt/chroot and drops you in as your user
# Features: safe mounts, recursive extra partitions, auto cleanup on exit/error
# =============================================================================

set -euo pipefail
shopt -s nocasematch  # case-insensitive matching for yes/no

CHROOT="/mnt/chroot"
USER="msifland"  # Change if your username is different

# ----------------------------- Cleanup Function (critical!) -------------
cleanup() {
    echo -e "\n${ILCOLOR1}Unmounting everything safely...${ILRESTORE}"
    local mounts=()
    mapfile -t mounts < <(mount | awk -v chroot="$CHROOT" '$3 ~ "^"chroot {print $3}' | sort -r)

    for m in "${mounts[@]}"; do
        echo "  Unmounting $m"
        sudo umount -f "$m" || sudo umount -l "$m"  # -l = lazy if busy
    done

    echo -e "${ILCOLOR2}Cleanup complete.${ILRESTORE}"
}

trap cleanup EXIT  # ← This guarantees unmount even on Ctrl+C or error

# ----------------------------- Header -----------------------------
clear
echo -e "${ILCOLOR4}╔═══════════════════════════════════════════════════════════════╗"
echo -e "${ILCOLOR4}║                Linux Chroot Rescue / Repair Tool              ║"
echo -e "${ILCOLOR4}╚═══════════════════════════════════════════════════════════════╝${ILRESTORE}\n"

# ----------------------------- Prepare chroot dir ------------------------
echo -e "${ILCOLOR3}Preparing $CHROOT directory...${ILRESTORE}"
if [[ ! -d "$CHROOT" ]]; then
    sudo mkdir -p "$CHROOT"
else
    echo -e "${ILCOLOR3}Cleaning existing $CHROOT contents...${ILRESTORE}"
    sudo rm -rf "$CHROOT"/*
fi

# ----------------------------- Show disks -----------------------------
echo -e "\n${ILCOLOR3}Available block devices:${ILRESTORE}"
lsblk -fpo NAME,SIZE,FSTYPE,LABEL,MOUNTPOINT
echo

# ----------------------------- Mount root partition -----------------------
while true; do
    read -rp "${ILCOLOR3}Enter device for root filesystem (e.g. /dev/sda1, /dev/sdd2): ${ILRESTORE}" ROOT_DEV
    if [[ -b "$ROOT_DEV" ]]; then
        echo -e "${ILCOLOR3}Mounting $ROOT_DEV → $CHROOT${ILRESTORE}"
        sudo mount --mkdir "$ROOT_DEV" "$CHROOT" && break
    else
        echo -e "${ILCOLOR1}Device $ROOT_DEV not found. Try again.${ILRESTORE}"
    fi
done

# --------------- Mount additional partitions -----------------------------
mount_extra() {
    while true; do
        echo
        read -rp "${ILCOLOR3}Additional partition to mount? (e.g. /dev/sda2) [blank = done]: ${ILRESTORE}" EXTRA_DEV
        [[ -z "$EXTRA_DEV" ]] && break

        if [[ ! -b "$EXTRA_DEV" ]]; then
            echo -e "${ILCOLOR1}Invalid device. Try again.${ILRESTORE}"
            continue
        fi

        read -rp "${ILCOLOR3}Mount $EXTRA_DEV inside chroot as (e.g. home, boot, var): ${ILRESTORE}" TARGET_DIR
        TARGET_DIR="${TARGET_DIR#/}"  # strip leading slash if present
        FULL_PATH="$CHROOT/$TARGET_DIR"

        sudo mkdir -p "$FULL_PATH"
        echo -e "${ILCOLOR3}Mounting $EXTRA_DEV → $FULL_PATH${ILRESTORE}"
        sudo mount --mkdir "$EXTRA_DEV" "$FULL_PATH"
    done
}

echo -e "\n${ILCOLOR3}Mount additional partitions (separate /home, /boot, etc.)?${ILRESTORE}"
mount_extra

# ----------------------------- Bind mounts -----------------------------
echo -e "\n${ILCOLOR3}Binding essential system directories...${ILRESTORE}"
for dir in /dev /dev/pts /proc /sys /run; do
    sudo mount --bind "$dir" "$CHROOT$dir" 2>/dev/null || sudo mount --make-rslave "$dir" "$CHROOT$dir"
done

# Special case for /dev/pts
sudo mount -t devpts devpts "$CHROOT/dev/pts" 2>/dev/null || true

# ----------------------------- DNS -----------------------------
echo -e "${ILCOLOR3}Copying DNS configuration...${ILRESTORE}"
sudo cp -f /etc/resolv.conf "$CHROOT/etc/resolv.conf"

# ----------------------------- Final instructions -------------------------
clear
echo -e "${ILCOLOR4}╔═══════════════════════════════════════════════════════════════╗"
echo -e "${ILCOLOR4}║                       CHROOT READY                            ║"
echo -e "${ILCOLOR4}╚═══════════════════════════════════════════════════════════════╝${ILRESTORE}\n"
echo -e "${ILCOLOR2}You will be dropped into the chroot as user: $USER${ILRESTORE}"
echo -e "${ILCOLOR2}→ If needed, run 'sudo -i' to become root${ILRESTORE}"
echo -e "${ILCOLOR2}→ When finished, type 'exit' (possibly twice if you ran 'bash')${ILRESTORE}\n"

sleep 3

# ----------------------------- Enter chroot -----------------------------
sudo chroot "$CHROOT" /bin/bash -c "su - $USER" || echo -e "${ILCOLOR1}Chroot failed. Check mounts above.${ILRESTORE}"

# ----------------------------- Script ends → trap runs cleanup -----------
echo -e "\n${ILCOLOR2}You are now back in the live system.${ILRESTORE}"
echo -e "${ILCOLOR4}All mounts have been safely unmounted. Have a great day!${ILRESTORE}\n"
